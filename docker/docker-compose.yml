# IntentForge - Docker Compose with LiteLLM and Ollama Support
# 
# Usage:
#   docker-compose up -d                    # Default (uses Anthropic API)
#   docker-compose --profile ollama up -d   # With local Ollama
#   docker-compose --profile litellm up -d  # With LiteLLM proxy
#   docker-compose --profile full up -d     # All services

version: "3.9"

services:
  # ==========================================================================
  # Core Services
  # ==========================================================================
  
  intentforge:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: intentforge-server
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8000}:${APP_PORT:-8000}"
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - HOST=${APP_HOST:-0.0.0.0}
      - PORT=${APP_PORT:-8000}
      - DB_HOST=postgres
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME:-intentforge}
      - DB_USER=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-intentforge}
      - MQTT_HOST=mosquitto
      - MQTT_PORT=${MQTT_PORT:-1883}
      - REDIS_URL=redis://redis:${REDIS_PORT:-6379}/0
      # LLM Configuration - set via .env
      - LLM_PROVIDER=${LLM_PROVIDER:-anthropic}
      - LLM_MODEL=${LLM_MODEL:-claude-sonnet-4-5-20250929}
      - LLM_API_KEY=${LLM_API_KEY:-}
      - OLLAMA_HOST=${OLLAMA_HOST:-http://ollama:${OLLAMA_PORT:-11434}}
      - LITELLM_API_BASE=${LITELLM_API_BASE:-http://litellm:${LITELLM_PORT:-4000}}
    env_file:
      - .env
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      mosquitto:
        condition: service_started
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    networks:
      - intentforge-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${APP_PORT:-8000}/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================================================
  # MQTT Broker
  # ==========================================================================
  
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: intentforge-mqtt
    restart: unless-stopped
    ports:
      - "${MQTT_PORT_EXTERNAL:-1883}:${MQTT_PORT:-1883}"
      - "${MQTT_WEBSOCKET_PORT_EXTERNAL:-9001}:${MQTT_WEBSOCKET_PORT:-9001}"
    volumes:
      - ./docker/config/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mosquitto-data:/mosquitto/data
    networks:
      - intentforge-network

  # ==========================================================================
  # PostgreSQL
  # ==========================================================================
  
  postgres:
    image: postgres:16-alpine
    container_name: intentforge-db
    restart: unless-stopped
    ports:
      - "${DB_PORT_EXTERNAL:-5432}:${DB_PORT:-5432}"
    environment:
      - POSTGRES_USER=${DB_USER:-postgres}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-intentforge}
      - POSTGRES_DB=${DB_NAME:-intentforge}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - intentforge-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # Redis
  # ==========================================================================
  
  redis:
    image: redis:7-alpine
    container_name: intentforge-cache
    restart: unless-stopped
    ports:
      - "${REDIS_PORT_EXTERNAL:-6379}:${REDIS_PORT:-6379}"
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - intentforge-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # Nginx (Frontend)
  # ==========================================================================
  
  nginx:
    image: nginx:alpine
    container_name: intentforge-web
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-80}:80"
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
      - ./docker/config/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - intentforge
      - mosquitto
    networks:
      - intentforge-network

  # ==========================================================================
  # Ollama (Local LLM) - Optional
  # ==========================================================================
  
#  ollama:
#    image: ollama/ollama:latest
#    container_name: intentforge-ollama
#    profiles: ["ollama", "full"]
#    restart: unless-stopped
#    ports:
#      - "11434:11434"
#    volumes:
#      - ollama-data:/root/.ollama
#    networks:
#      - intentforge-network
#    # Pull default model on first start
#    # Run: docker exec intentforge-ollama ollama pull llama3
#    deploy:
#      resources:
#        reservations:
#          devices:
#            - driver: nvidia
#              count: all
#              capabilities: [gpu]
    # For CPU-only, remove the deploy section above

  # ==========================================================================
  # LiteLLM Proxy - Optional (supports 100+ models)
  # ==========================================================================
  
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: intentforge-litellm
    profiles: ["litellm", "full"]
    restart: unless-stopped
    ports:
      - "${LITELLM_PORT_EXTERNAL:-4000}:${LITELLM_PORT:-4000}"
    environment:
      # Add API keys for providers you want to use
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - AZURE_API_KEY=${AZURE_API_KEY:-}
      - COHERE_API_KEY=${COHERE_API_KEY:-}
      # Ollama connection
      - OLLAMA_API_BASE=http://ollama:${OLLAMA_PORT:-11434}
    volumes:
      - ./docker/config/litellm_config.yaml:/app/config.yaml:ro
    command: ["--config", "/app/config.yaml", "--port", "${LITELLM_PORT:-4000}"]
    networks:
      - intentforge-network
    depends_on:
      - ollama

  # ==========================================================================
  # Development Tools
  # ==========================================================================
  
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: intentforge-pgadmin
    profiles: ["dev"]
    restart: unless-stopped
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@example.com
      - PGADMIN_DEFAULT_PASSWORD=admin
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - intentforge-network

  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: intentforge-redis-ui
    profiles: ["dev"]
    restart: unless-stopped
    ports:
      - "${REDIS_COMMANDER_PORT:-8081}:8081"
    environment:
      - REDIS_HOSTS=local:redis:${REDIS_PORT:-6379}
    depends_on:
      - redis
    networks:
      - intentforge-network

# ==========================================================================
# Networks
# ==========================================================================

networks:
  intentforge-network:
    driver: bridge

# ==========================================================================
# Volumes
# ==========================================================================

volumes:
  postgres-data:
  redis-data:
  mosquitto-data:
  ollama-data:
  pgadmin-data:
