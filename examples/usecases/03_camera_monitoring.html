<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Kamery AI - IntentForge Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #1a1a2e; color: #eee; }
        .camera-feed {
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .camera-feed img {
            width: 100%;
            height: auto;
            display: block;
        }
        .camera-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
        }
        .detection-box {
            position: absolute;
            border: 2px solid #00ff00;
            background: rgba(0, 255, 0, 0.1);
        }
        .detection-label {
            position: absolute;
            top: -20px;
            left: 0;
            background: #00ff00;
            color: #000;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        .status-live { background: #dc3545; }
        .status-recording { background: #28a745; }
        .event-log {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .event-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .event-item:last-child { border-bottom: none; }
        .event-motion { border-left: 3px solid #ffc107; }
        .event-person { border-left: 3px solid #dc3545; }
        .event-vehicle { border-left: 3px solid #17a2b8; }
        .stats-card {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 20px;
        }
        .stats-number { font-size: 2rem; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <!-- Header -->
            <div class="col-12 mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2>üé• AI Camera Monitor</h2>
                        <small class="text-muted">Analiza obrazu w czasie rzeczywistym</small>
                    </div>
                    <div>
                        <span id="connection-status" class="badge bg-secondary">≈ÅƒÖczenie...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Main Camera Feed -->
            <div class="col-lg-8 mb-4">
                <div class="card bg-dark">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>üìπ Kamera g≈Ç√≥wna - Wej≈õcie</span>
                        <div>
                            <span class="status-badge status-live">‚óè LIVE</span>
                            <span id="fps-counter" class="status-badge bg-secondary ms-2">-- FPS</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="camera-feed" id="camera-container">
                            <img id="camera-main"
                                 src="/api/camera/snapshot?source=front-door"
                                 alt="Camera Feed">

                            <!-- Detection boxes will be added here dynamically -->
                            <div id="detection-overlay"></div>

                            <!-- Overlay info -->
                            <div class="camera-overlay">
                                <span class="badge bg-dark">
                                    <span id="camera-time">--:--:--</span>
                                </span>
                                <span class="badge bg-dark">
                                    AI: <span id="ai-status">Aktywne</span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="row">
                            <div class="col">
                                <button id="btn-snapshot" class="btn btn-outline-light btn-sm">
                                    üì∑ Zrzut ekranu
                                </button>
                                <button id="btn-analyze" class="btn btn-outline-primary btn-sm">
                                    üîç Analizuj teraz
                                </button>
                            </div>
                            <div class="col text-end">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="detect-motion" checked>
                                    <label class="form-check-label" for="detect-motion">Ruch</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="detect-person" checked>
                                    <label class="form-check-label" for="detect-person">Osoby</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="detect-vehicle" checked>
                                    <label class="form-check-label" for="detect-vehicle">Pojazdy</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Side Panel -->
            <div class="col-lg-4">
                <!-- Stats -->
                <div class="row mb-4">
                    <div class="col-6">
                        <div class="stats-card text-center">
                            <div class="stats-number text-warning" id="stat-motion">0</div>
                            <small>Wykryty ruch</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stats-card text-center">
                            <div class="stats-number text-danger" id="stat-person">0</div>
                            <small>Osoby</small>
                        </div>
                    </div>
                </div>

                <!-- Alert Settings -->
                <div class="card bg-dark mb-4">
                    <div class="card-header">
                        ‚öôÔ∏è Ustawienia alert√≥w
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Email do powiadomie≈Ñ</label>
                            <input type="email" id="alert-email" class="form-control bg-dark text-light"
                                   placeholder="twoj@email.com">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Powiadamiaj gdy:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert-motion">
                                <label class="form-check-label" for="alert-motion">
                                    Wykryto ruch (czƒôstotliwo≈õƒá: 1/min)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert-person" checked>
                                <label class="form-check-label" for="alert-person">
                                    Wykryto osobƒô
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert-vehicle">
                                <label class="form-check-label" for="alert-vehicle">
                                    Wykryto pojazd
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Godziny aktywno≈õci</label>
                            <div class="row">
                                <div class="col">
                                    <input type="time" id="alert-from" class="form-control bg-dark text-light"
                                           value="22:00">
                                </div>
                                <div class="col-auto pt-2">do</div>
                                <div class="col">
                                    <input type="time" id="alert-to" class="form-control bg-dark text-light"
                                           value="06:00">
                                </div>
                            </div>
                        </div>

                        <button id="save-alerts" class="btn btn-primary w-100">
                            üíæ Zapisz ustawienia
                        </button>
                    </div>
                </div>

                <!-- Event Log -->
                <div class="card bg-dark">
                    <div class="card-header d-flex justify-content-between">
                        <span>üìã Historia zdarze≈Ñ</span>
                        <button class="btn btn-sm btn-outline-secondary" id="clear-log">
                            Wyczy≈õƒá
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="event-log" id="event-log">
                            <div class="text-center text-muted p-4">
                                Oczekiwanie na zdarzenia...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Cameras -->
        <div class="row mt-4">
            <div class="col-12">
                <h5>üìπ Dodatkowe kamery</h5>
            </div>
            <div class="col-md-4 mb-3">
                <div class="camera-feed" style="height: 200px;">
                    <img id="camera-back"
                         data-src="/api/camera/snapshot?source=back-yard"
                         style="height: 100%; object-fit: cover;"
                         alt="Back yard">
                </div>
                <small class="text-muted">Podw√≥rko</small>
            </div>
            <div class="col-md-4 mb-3">
                <div class="camera-feed" style="height: 200px;">
                    <img id="camera-garage"
                         data-src="/api/camera/snapshot?source=garage"
                         style="height: 100%; object-fit: cover;"
                         alt="Garage">
                </div>
                <small class="text-muted">Gara≈º</small>
            </div>
            <div class="col-md-4 mb-3">
                <div class="camera-feed" style="height: 200px;">
                    <img id="camera-parking"
                         data-src="/api/camera/snapshot?source=parking"
                         style="height: 100%; object-fit: cover;"
                         alt="Parking">
                </div>
                <small class="text-muted">Parking</small>
            </div>
        </div>
    </div>

    <!-- IntentForge SDK -->
    <script src="/sdk/intentforge.js" data-broker="ws://localhost:9001"></script>

    <script>
        // =================================================================
        // Configuration
        // =================================================================
        const CONFIG = {
            mainCamera: 'rtsp://192.168.1.100:554/stream1',
            refreshInterval: 1000,  // 1 second
            analysisInterval: 5000, // 5 seconds
            maxLogItems: 50
        };

        let api;
        let stats = { motion: 0, person: 0, vehicle: 0 };
        let lastAnalysis = null;
        let analysisEnabled = true;

        // =================================================================
        // Initialize
        // =================================================================
        async function init() {
            try {
                api = await IntentForge.connect('ws://localhost:9001', { debug: true });

                document.getElementById('connection-status').className = 'badge bg-success';
                document.getElementById('connection-status').textContent = 'üü¢ Po≈ÇƒÖczony';

                // Start camera refresh
                startCameraRefresh();

                // Start analysis loop
                startAnalysis();

                // Subscribe to events
                subscribeToEvents();

                // Update clock
                setInterval(updateClock, 1000);

            } catch (error) {
                document.getElementById('connection-status').className = 'badge bg-danger';
                document.getElementById('connection-status').textContent = 'üî¥ B≈ÇƒÖd po≈ÇƒÖczenia';
                console.error('Connection error:', error);
            }
        }

        // =================================================================
        // Camera Refresh
        // =================================================================
        function startCameraRefresh() {
            // Main camera - faster refresh
            api.image.refresh('#camera-main', CONFIG.refreshInterval,
                '/api/camera/snapshot?source=front-door');

            // Secondary cameras - slower refresh
            api.image.refresh('#camera-back', 5000);
            api.image.refresh('#camera-garage', 5000);
            api.image.refresh('#camera-parking', 5000);

            // FPS counter
            let frameCount = 0;
            setInterval(() => {
                document.getElementById('fps-counter').textContent = `${frameCount} FPS`;
                frameCount = 0;
            }, 1000);

            // Count frames
            const mainImg = document.getElementById('camera-main');
            mainImg.addEventListener('load', () => frameCount++);
        }

        // =================================================================
        // AI Analysis
        // =================================================================
        function startAnalysis() {
            setInterval(async () => {
                if (!analysisEnabled) return;

                const detectTypes = [];
                if (document.getElementById('detect-motion').checked) detectTypes.push('motion');
                if (document.getElementById('detect-person').checked) detectTypes.push('person');
                if (document.getElementById('detect-vehicle').checked) detectTypes.push('vehicle');

                if (detectTypes.length === 0) return;

                try {
                    // Pobierz analizƒô z backendu
                    const result = await api._request('camera', {
                        action: 'analyze',
                        source: CONFIG.mainCamera,
                        detect: detectTypes
                    });

                    handleAnalysisResult(result);

                } catch (error) {
                    console.error('Analysis error:', error);
                }
            }, CONFIG.analysisInterval);
        }

        function handleAnalysisResult(result) {
            lastAnalysis = result;

            // Clear existing detection boxes
            document.getElementById('detection-overlay').innerHTML = '';

            if (!result.detections || result.detections.length === 0) return;

            const container = document.getElementById('camera-container');
            const overlay = document.getElementById('detection-overlay');

            result.detections.forEach(detection => {
                // Update stats
                if (detection.type === 'motion') stats.motion++;
                if (detection.type === 'person') stats.person++;
                if (detection.type === 'vehicle') stats.vehicle++;

                // Draw detection box
                if (detection.bbox) {
                    const box = document.createElement('div');
                    box.className = 'detection-box';
                    box.style.left = `${detection.bbox.x * 100}%`;
                    box.style.top = `${detection.bbox.y * 100}%`;
                    box.style.width = `${detection.bbox.width * 100}%`;
                    box.style.height = `${detection.bbox.height * 100}%`;

                    const label = document.createElement('span');
                    label.className = 'detection-label';
                    label.textContent = `${detection.type} ${(detection.confidence * 100).toFixed(0)}%`;
                    box.appendChild(label);

                    overlay.appendChild(box);
                }

                // Add to event log
                addEventLog(detection);
            });

            // Update stats display
            document.getElementById('stat-motion').textContent = stats.motion;
            document.getElementById('stat-person').textContent = stats.person;
        }

        // =================================================================
        // Event Subscription (Real-time alerts from backend)
        // =================================================================
        function subscribeToEvents() {
            // Motion detection
            api.on('camera:motion', (data) => {
                addEventLog({ type: 'motion', timestamp: new Date(), ...data });
                checkAndNotify('motion', data);
            });

            // Person detection
            api.on('camera:person', (data) => {
                addEventLog({ type: 'person', timestamp: new Date(), ...data });
                checkAndNotify('person', data);
            });

            // Vehicle detection
            api.on('camera:vehicle', (data) => {
                addEventLog({ type: 'vehicle', timestamp: new Date(), ...data });
                checkAndNotify('vehicle', data);
            });
        }

        async function checkAndNotify(type, data) {
            const email = document.getElementById('alert-email').value;
            const alertCheckbox = document.getElementById(`alert-${type}`);

            if (!email || !alertCheckbox?.checked) return;

            // Check time restrictions
            const now = new Date();
            const from = document.getElementById('alert-from').value;
            const to = document.getElementById('alert-to').value;

            if (!isWithinTimeRange(now, from, to)) return;

            // Send email notification
            try {
                await api.email.send({
                    to: email,
                    template: 'camera_alert',
                    data: {
                        type: type,
                        camera: 'Wej≈õcie g≈Ç√≥wne',
                        timestamp: now.toISOString(),
                        snapshot: data.snapshot_url,
                        confidence: data.confidence
                    }
                });

                console.log(`Alert sent for ${type} detection`);
            } catch (error) {
                console.error('Failed to send alert:', error);
            }
        }

        function isWithinTimeRange(date, from, to) {
            const current = date.getHours() * 60 + date.getMinutes();
            const [fromH, fromM] = from.split(':').map(Number);
            const [toH, toM] = to.split(':').map(Number);
            const fromMinutes = fromH * 60 + fromM;
            const toMinutes = toH * 60 + toM;

            if (fromMinutes <= toMinutes) {
                return current >= fromMinutes && current <= toMinutes;
            } else {
                // Overnight range (e.g., 22:00 - 06:00)
                return current >= fromMinutes || current <= toMinutes;
            }
        }

        // =================================================================
        // Event Log
        // =================================================================
        function addEventLog(event) {
            const log = document.getElementById('event-log');
            const timestamp = event.timestamp || new Date();

            const item = document.createElement('div');
            item.className = `event-item event-${event.type}`;

            const typeEmoji = {
                motion: 'üîî',
                person: 'üë§',
                vehicle: 'üöó'
            };

            item.innerHTML = `
                <div class="d-flex justify-content-between">
                    <strong>${typeEmoji[event.type] || '‚ùì'} ${event.type}</strong>
                    <small class="text-muted">${formatTime(timestamp)}</small>
                </div>
                ${event.confidence ? `<small>Pewno≈õƒá: ${(event.confidence * 100).toFixed(0)}%</small>` : ''}
            `;

            // Clear placeholder
            if (log.querySelector('.text-muted')) {
                log.innerHTML = '';
            }

            log.insertBefore(item, log.firstChild);

            // Limit items
            while (log.children.length > CONFIG.maxLogItems) {
                log.removeChild(log.lastChild);
            }
        }

        // =================================================================
        // UI Handlers
        // =================================================================

        document.getElementById('btn-snapshot').addEventListener('click', async () => {
            const result = await api._request('camera', {
                action: 'snapshot',
                source: CONFIG.mainCamera,
                save: true
            });

            if (result.url) {
                const link = document.createElement('a');
                link.href = result.url;
                link.download = `snapshot-${Date.now()}.jpg`;
                link.click();
            }
        });

        document.getElementById('btn-analyze').addEventListener('click', async () => {
            document.getElementById('btn-analyze').disabled = true;
            document.getElementById('btn-analyze').textContent = '‚è≥ Analizujƒô...';

            try {
                const result = await api._request('camera', {
                    action: 'analyze',
                    source: CONFIG.mainCamera,
                    detect: ['motion', 'person', 'vehicle', 'objects']
                });

                handleAnalysisResult(result);

            } finally {
                document.getElementById('btn-analyze').disabled = false;
                document.getElementById('btn-analyze').textContent = 'üîç Analizuj teraz';
            }
        });

        document.getElementById('save-alerts').addEventListener('click', async () => {
            const settings = {
                email: document.getElementById('alert-email').value,
                alerts: {
                    motion: document.getElementById('alert-motion').checked,
                    person: document.getElementById('alert-person').checked,
                    vehicle: document.getElementById('alert-vehicle').checked
                },
                schedule: {
                    from: document.getElementById('alert-from').value,
                    to: document.getElementById('alert-to').value
                }
            };

            await api.data('camera_settings').update('user', settings);
            alert('Ustawienia zapisane!');
        });

        document.getElementById('clear-log').addEventListener('click', () => {
            document.getElementById('event-log').innerHTML = `
                <div class="text-center text-muted p-4">
                    Oczekiwanie na zdarzenia...
                </div>
            `;
            stats = { motion: 0, person: 0, vehicle: 0 };
            document.getElementById('stat-motion').textContent = '0';
            document.getElementById('stat-person').textContent = '0';
        });

        // =================================================================
        // Helpers
        // =================================================================

        function updateClock() {
            document.getElementById('camera-time').textContent =
                new Date().toLocaleTimeString('pl-PL');
        }

        function formatTime(date) {
            return new Date(date).toLocaleTimeString('pl-PL');
        }

        // =================================================================
        // Start
        // =================================================================
        init();
    </script>
</body>
</html>
