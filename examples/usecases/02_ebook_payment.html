<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kup E-book - IntentForge Payment Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .product-card { max-width: 400px; margin: 50px auto; }
        .price { font-size: 2.5rem; font-weight: bold; color: #28a745; }
        .price-currency { font-size: 1rem; }
        .features li { padding: 8px 0; border-bottom: 1px solid #eee; }
        .features li:last-child { border-bottom: none; }
        .payment-buttons { display: flex; flex-direction: column; gap: 10px; }
        .btn-paypal { background: #ffc439; border-color: #ffc439; color: #003087; }
        .btn-paypal:hover { background: #f0b90b; border-color: #f0b90b; color: #003087; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: none;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .loading-overlay.active { display: flex; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay">
        <div class="bg-white p-4 rounded shadow text-center">
            <div class="spinner-border text-primary mb-3"></div>
            <p class="mb-0">PrzekierowujÄ™ do pÅ‚atnoÅ›ci...</p>
        </div>
    </div>

    <div class="container py-5">
        <!-- Product Card -->
        <div class="card product-card shadow">
            <div class="card-header bg-primary text-white text-center py-4">
                <h2 class="mb-0">ðŸ“š Python dla PoczÄ…tkujÄ…cych</h2>
                <small>Kompleksowy kurs programowania</small>
            </div>

            <div class="card-body">
                <!-- Price -->
                <div class="text-center mb-4">
                    <span class="price">49<span class="price-currency">,99 PLN</span></span>
                    <p class="text-muted mb-0"><del>99,99 PLN</del> - 50% zniÅ¼ki!</p>
                </div>

                <!-- Features -->
                <ul class="features list-unstyled mb-4">
                    <li>âœ… 200+ stron treÅ›ci</li>
                    <li>âœ… 50 praktycznych przykÅ‚adÃ³w</li>
                    <li>âœ… Projekty do samodzielnej realizacji</li>
                    <li>âœ… DostÄ™p do kodu ÅºrÃ³dÅ‚owego</li>
                    <li>âœ… Aktualizacje na zawsze</li>
                    <li>âœ… 30-dniowa gwarancja zwrotu</li>
                </ul>

                <!-- Email Input -->
                <div class="mb-3">
                    <label class="form-label">Email (do wysÅ‚ania e-booka)</label>
                    <input type="email" id="customer-email" class="form-control"
                           placeholder="twoj@email.com" required>
                </div>

                <!-- Discount Code -->
                <div class="mb-4">
                    <label class="form-label">Kod rabatowy (opcjonalnie)</label>
                    <div class="input-group">
                        <input type="text" id="discount-code" class="form-control"
                               placeholder="RABAT20">
                        <button class="btn btn-outline-secondary" id="apply-discount">
                            Zastosuj
                        </button>
                    </div>
                    <div id="discount-message" class="small mt-1"></div>
                </div>

                <!-- Payment Buttons -->
                <div class="payment-buttons">
                    <button id="pay-paypal" class="btn btn-paypal btn-lg">
                        <img src="https://www.paypalobjects.com/webstatic/mktg/logo/pp_cc_mark_37x23.jpg"
                             alt="PayPal" style="height: 20px; margin-right: 8px;">
                        ZapÅ‚aÄ‡ przez PayPal
                    </button>

                    <button id="pay-card" class="btn btn-primary btn-lg">
                        ðŸ’³ ZapÅ‚aÄ‡ kartÄ…
                    </button>

                    <button id="pay-blik" class="btn btn-outline-primary btn-lg">
                        ðŸ“± BLIK / Przelewy24
                    </button>
                </div>

                <!-- Security Info -->
                <div class="text-center mt-4">
                    <small class="text-muted">
                        ðŸ”’ Bezpieczna pÅ‚atnoÅ›Ä‡ |
                        ðŸ“§ E-book wysyÅ‚any natychmiast |
                        ðŸ”„ 30-dniowy zwrot
                    </small>
                </div>
            </div>
        </div>

        <!-- Testimonials -->
        <div class="row mt-5">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <p class="card-text">"Najlepszy kurs Pythona jaki spotkaÅ‚em. Praktyczne podejÅ›cie!"</p>
                        <small class="text-muted">â€” Jan K., Developer</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <p class="card-text">"Po 2 tygodniach napisaÅ‚em swojÄ… pierwszÄ… aplikacjÄ™."</p>
                        <small class="text-muted">â€” Anna M., Student</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <p class="card-text">"Åšwietna inwestycja. Polecam kaÅ¼demu poczÄ…tkujÄ…cemu."</p>
                        <small class="text-muted">â€” Piotr W., Freelancer</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- IntentForge SDK -->
    <script src="/sdk/intentforge.js" data-broker="ws://localhost:9001"></script>

    <script>
        // =================================================================
        // Product Configuration
        // =================================================================
        const PRODUCT = {
            id: 'ebook-python-beginners',
            name: 'Python dla PoczÄ…tkujÄ…cych',
            price: 49.99,
            currency: 'PLN',
            downloadUrl: '/downloads/python-ebook.pdf'
        };

        let currentPrice = PRODUCT.price;
        let discountApplied = null;

        // =================================================================
        // Initialize IntentForge
        // =================================================================
        let api;

        async function init() {
            api = await IntentForge.connect('ws://localhost:9001', { debug: true });
            console.log('IntentForge connected');
        }

        init();

        // =================================================================
        // Discount Code Handler
        // =================================================================
        document.getElementById('apply-discount').addEventListener('click', async () => {
            const code = document.getElementById('discount-code').value.trim();
            const messageEl = document.getElementById('discount-message');

            if (!code) return;

            try {
                // Weryfikacja kodu rabatowego przez backend
                const result = await api._request('discount', {
                    action: 'verify',
                    code: code,
                    product_id: PRODUCT.id
                });

                if (result.valid) {
                    discountApplied = result;
                    currentPrice = PRODUCT.price * (1 - result.discount / 100);

                    messageEl.className = 'small mt-1 text-success';
                    messageEl.textContent = `âœ… Kod zastosowany! ZniÅ¼ka ${result.discount}%`;

                    // Update displayed price
                    document.querySelector('.price').innerHTML =
                        `${currentPrice.toFixed(2).replace('.', ',')}<span class="price-currency"> PLN</span>`;
                } else {
                    messageEl.className = 'small mt-1 text-danger';
                    messageEl.textContent = 'âŒ NieprawidÅ‚owy kod rabatowy';
                }
            } catch (error) {
                messageEl.className = 'small mt-1 text-danger';
                messageEl.textContent = 'âŒ BÅ‚Ä…d weryfikacji kodu';
            }
        });

        // =================================================================
        // Payment Handlers
        // =================================================================

        async function processPayment(provider) {
            const email = document.getElementById('customer-email').value.trim();

            if (!email || !email.includes('@')) {
                alert('Podaj prawidÅ‚owy adres email');
                return;
            }

            document.getElementById('loading').classList.add('active');

            try {
                // WywoÅ‚anie pÅ‚atnoÅ›ci przez IntentForge
                const result = await api.payment.checkout({
                    amount: currentPrice,
                    currency: PRODUCT.currency,
                    product: PRODUCT.id,
                    productName: PRODUCT.name,
                    email: email,
                    provider: provider,
                    discountCode: discountApplied?.code,
                    returnUrl: window.location.href + '?payment=success',
                    cancelUrl: window.location.href + '?payment=cancelled',

                    // Metadata dla backendu
                    metadata: {
                        download_url: PRODUCT.downloadUrl,
                        send_email: true,
                        email_template: 'ebook_purchase'
                    }
                });

                if (result.redirect_url) {
                    // Przekierowanie do bramki pÅ‚atnoÅ›ci
                    window.location.href = result.redirect_url;
                } else if (result.payment_id) {
                    // PÅ‚atnoÅ›Ä‡ inline (np. BLIK)
                    showInlinePayment(result);
                }

            } catch (error) {
                document.getElementById('loading').classList.remove('active');
                alert('BÅ‚Ä…d pÅ‚atnoÅ›ci: ' + error.message);
            }
        }

        // PayPal
        document.getElementById('pay-paypal').addEventListener('click', () => {
            processPayment('paypal');
        });

        // Card (Stripe)
        document.getElementById('pay-card').addEventListener('click', () => {
            processPayment('stripe');
        });

        // BLIK / P24
        document.getElementById('pay-blik').addEventListener('click', () => {
            processPayment('przelewy24');
        });

        // =================================================================
        // Payment Success Handler
        // =================================================================

        async function checkPaymentStatus() {
            const params = new URLSearchParams(window.location.search);

            if (params.get('payment') === 'success') {
                const paymentId = params.get('payment_id');

                if (paymentId) {
                    try {
                        const result = await api.payment.verify(paymentId);

                        if (result.status === 'completed') {
                            showSuccessMessage(result);
                        }
                    } catch (error) {
                        console.error('Payment verification error:', error);
                    }
                }
            } else if (params.get('payment') === 'cancelled') {
                alert('PÅ‚atnoÅ›Ä‡ zostaÅ‚a anulowana');
            }
        }

        function showSuccessMessage(result) {
            document.querySelector('.product-card').innerHTML = `
                <div class="card-body text-center py-5">
                    <div class="display-1 mb-4">ðŸŽ‰</div>
                    <h2 class="text-success">DziÄ™kujemy za zakup!</h2>
                    <p class="lead">E-book zostaÅ‚ wysÅ‚any na adres:</p>
                    <p class="h5">${result.email}</p>
                    <hr>
                    <p>MoÅ¼esz rÃ³wnieÅ¼ pobraÄ‡ go bezpoÅ›rednio:</p>
                    <a href="${result.download_url}" class="btn btn-primary btn-lg">
                        ðŸ“¥ Pobierz E-book
                    </a>
                    <p class="mt-4 text-muted">
                        <small>ID zamÃ³wienia: ${result.order_id}</small>
                    </p>
                </div>
            `;
        }

        // Check on page load
        checkPaymentStatus();
    </script>
</body>
</html>
