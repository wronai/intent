<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntentForge - Example 2: Static HTML + MQTT</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.css" rel="stylesheet">
    
    <style>
        .intent-processing { opacity: 0.6; pointer-events: none; }
        .code-output { max-height: 400px; overflow: auto; }
        .status-badge { position: fixed; top: 10px; right: 10px; }
        pre { margin: 0; border-radius: 8px; }
        .example-card { transition: transform 0.2s; cursor: pointer; }
        .example-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    </style>
</head>
<body class="bg-light">

    <!-- Status Badge -->
    <div class="status-badge">
        <span id="mqtt-status" class="badge bg-secondary">Connecting...</span>
    </div>

    <div class="container py-5">
        <div class="text-center mb-5">
            <h1>üîß IntentForge</h1>
            <p class="lead">Generowanie kodu z naturalnego jƒôzyka przez MQTT</p>
            <p class="text-muted">Statyczna strona HTML bez backendu - wszystko przez MQTT</p>
        </div>

        <!-- Main Input -->
        <div class="row justify-content-center mb-5">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-body">
                        <h5 class="card-title">üí¨ Opisz co chcesz wygenerowaƒá</h5>
                        
                        <div class="mb-3">
                            <textarea 
                                id="intent-input" 
                                class="form-control" 
                                rows="3"
                                placeholder="np. Stw√≥rz endpoint REST do zarzƒÖdzania produktami z paginacjƒÖ i wyszukiwaniem"
                            ></textarea>
                        </div>
                        
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <select id="platform-select" class="form-select">
                                    <option value="python_fastapi">Python FastAPI</option>
                                    <option value="python_flask">Python Flask</option>
                                    <option value="nodejs_express">Node.js Express</option>
                                    <option value="esp32_micropython">ESP32 MicroPython</option>
                                    <option value="arduino_cpp">Arduino C++</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select id="type-select" class="form-select">
                                    <option value="api_endpoint">API Endpoint</option>
                                    <option value="database_schema">Database Schema</option>
                                    <option value="event_handler">Event Handler</option>
                                    <option value="firmware_function">Firmware Function</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button id="generate-btn" class="btn btn-primary w-100">
                                    üöÄ Generuj kod
                                </button>
                            </div>
                        </div>
                        
                        <!-- Progress -->
                        <div id="progress-bar" class="progress d-none" style="height: 3px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Examples -->
        <div class="row mb-4">
            <div class="col-12">
                <h5 class="mb-3">‚ö° Szybkie przyk≈Çady (kliknij aby wype≈Çniƒá)</h5>
            </div>
            
            <div class="col-md-4 mb-3">
                <div class="card example-card h-100" data-intent="Create REST API for user management with JWT authentication and role-based access" data-type="api_endpoint">
                    <div class="card-body">
                        <h6>üë• User API</h6>
                        <small class="text-muted">CRUD u≈ºytkownik√≥w z JWT auth</small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 mb-3">
                <div class="card example-card h-100" data-intent="Create PostgreSQL schema for e-commerce with products, orders, and customers tables with proper indexes and relationships" data-type="database_schema">
                    <div class="card-body">
                        <h6>üõí E-commerce Schema</h6>
                        <small class="text-muted">Produkty, zam√≥wienia, klienci</small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 mb-3">
                <div class="card example-card h-100" data-intent="Create MQTT handler for IoT temperature sensor that reads DHT22 sensor and publishes data every 5 seconds" data-type="firmware_function" data-platform="esp32_micropython">
                    <div class="card-body">
                        <h6>üå°Ô∏è IoT Sensor</h6>
                        <small class="text-muted">ESP32 + DHT22 + MQTT</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Output -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>üìù Wygenerowany kod</span>
                        <div>
                            <span id="code-language" class="badge bg-info me-2">-</span>
                            <span id="code-time" class="badge bg-secondary me-2">-</span>
                            <button id="copy-btn" class="btn btn-sm btn-outline-secondary" disabled>
                                üìã Kopiuj
                            </button>
                        </div>
                    </div>
                    <div class="card-body code-output">
                        <pre><code id="code-output" class="language-python">// Wygenerowany kod pojawi siƒô tutaj...</code></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Validation Results -->
        <div id="validation-results" class="row mt-4 d-none">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">‚úÖ Wynik walidacji</div>
                    <div class="card-body">
                        <div id="validation-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Example Section -->
        <div class="row mt-5">
            <div class="col-12">
                <h4 class="mb-3">üìã Przyk≈Çad: Automatyczna obs≈Çuga formularza</h4>
                <p class="text-muted">Ten formularz automatycznie wysy≈Ça dane przez MQTT i generuje backend</p>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Formularz kontaktowy</div>
                    <div class="card-body">
                        <form id="contact-form" data-intent="Handle contact form submission and store in PostgreSQL">
                            <div class="mb-3">
                                <label class="form-label">Imiƒô i nazwisko</label>
                                <input type="text" name="name" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" name="email" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Wiadomo≈õƒá</label>
                                <textarea name="message" class="form-control" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-success">Wy≈õlij</button>
                            <button type="button" id="gen-form-backend" class="btn btn-outline-primary">
                                Generuj backend dla tego formularza
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Wygenerowany backend</div>
                    <div class="card-body code-output">
                        <pre><code id="form-backend-output" class="language-python">// Kliknij "Generuj backend" aby zobaczyƒá kod...</code></pre>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container text-center">
            <p>IntentForge - NLP-driven Code Generation via MQTT</p>
            <small class="text-muted">
                Po≈ÇƒÖczenie: <span id="mqtt-broker">ws://localhost:9001</span> | 
                Topic: <span id="mqtt-topic">intentforge/intent/request/*</span>
            </small>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/paho-mqtt@1.0.1/paho-mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-sql.min.js"></script>
    
    <script>
        // =================================================================
        // MQTT Configuration
        // =================================================================
        const MQTT_BROKER = 'localhost';
        const MQTT_PORT = 9001;
        const CLIENT_ID = `web-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        const TOPIC_PREFIX = 'intentforge';
        
        let client = null;
        let connected = false;
        const pendingRequests = new Map();
        
        // =================================================================
        // MQTT Connection
        // =================================================================
        function connectMQTT() {
            client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, CLIENT_ID);
            
            client.onConnectionLost = (response) => {
                connected = false;
                updateStatus('disconnected');
                setTimeout(connectMQTT, 5000);
            };
            
            client.onMessageArrived = handleMessage;
            
            client.connect({
                onSuccess: () => {
                    connected = true;
                    updateStatus('connected');
                    
                    // Subscribe to responses
                    client.subscribe(`${TOPIC_PREFIX}/intent/response/${CLIENT_ID}`);
                    client.subscribe(`${TOPIC_PREFIX}/intent/status/${CLIENT_ID}`);
                },
                onFailure: (err) => {
                    updateStatus('error');
                    console.error('MQTT connection failed:', err);
                    setTimeout(connectMQTT, 5000);
                }
            });
        }
        
        function updateStatus(status) {
            const badge = document.getElementById('mqtt-status');
            const statusMap = {
                'connected': { class: 'bg-success', text: 'üü¢ Connected' },
                'disconnected': { class: 'bg-warning', text: 'üü° Disconnected' },
                'error': { class: 'bg-danger', text: 'üî¥ Error' },
                'connecting': { class: 'bg-secondary', text: '‚ö™ Connecting...' }
            };
            const s = statusMap[status] || statusMap.connecting;
            badge.className = `badge ${s.class}`;
            badge.textContent = s.text;
        }
        
        // =================================================================
        // Message Handling
        // =================================================================
        function handleMessage(message) {
            try {
                const payload = JSON.parse(message.payloadString);
                
                if (payload.request_id && pendingRequests.has(payload.request_id)) {
                    const request = pendingRequests.get(payload.request_id);
                    clearTimeout(request.timeout);
                    pendingRequests.delete(payload.request_id);
                    
                    if (payload.success) {
                        request.resolve(payload);
                    } else {
                        request.reject(new Error(payload.error || 'Generation failed'));
                    }
                }
            } catch (e) {
                console.error('Error handling message:', e);
            }
        }
        
        // =================================================================
        // Send Intent
        // =================================================================
        function sendIntent(description, options = {}) {
            return new Promise((resolve, reject) => {
                if (!connected) {
                    reject(new Error('Not connected to MQTT broker'));
                    return;
                }
                
                const requestId = crypto.randomUUID();
                
                const intent = {
                    request_id: requestId,
                    description: description,
                    intent_type: options.intentType || 'api_endpoint',
                    target_platform: options.targetPlatform || 'python_fastapi',
                    context: options.context || {},
                    constraints: options.constraints || []
                };
                
                // Store pending request
                pendingRequests.set(requestId, {
                    resolve,
                    reject,
                    timeout: setTimeout(() => {
                        pendingRequests.delete(requestId);
                        reject(new Error('Request timeout (60s)'));
                    }, 60000)
                });
                
                // Send message
                const message = new Paho.MQTT.Message(JSON.stringify(intent));
                message.destinationName = `${TOPIC_PREFIX}/intent/request/${CLIENT_ID}`;
                message.qos = 1;
                
                client.send(message);
            });
        }
        
        // =================================================================
        // UI Handlers
        // =================================================================
        document.getElementById('generate-btn').addEventListener('click', async () => {
            const description = document.getElementById('intent-input').value.trim();
            if (!description) {
                alert('Wprowad≈∫ opis tego co chcesz wygenerowaƒá');
                return;
            }
            
            const platform = document.getElementById('platform-select').value;
            const intentType = document.getElementById('type-select').value;
            
            const btn = document.getElementById('generate-btn');
            const progress = document.getElementById('progress-bar');
            
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Generowanie...';
            progress.classList.remove('d-none');
            
            const startTime = Date.now();
            
            try {
                const result = await sendIntent(description, {
                    intentType: intentType,
                    targetPlatform: platform
                });
                
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
                
                // Update output
                const codeOutput = document.getElementById('code-output');
                codeOutput.textContent = result.generated_code || '// No code generated';
                codeOutput.className = `language-${result.language || 'python'}`;
                Prism.highlightElement(codeOutput);
                
                // Update badges
                document.getElementById('code-language').textContent = result.language || 'unknown';
                document.getElementById('code-time').textContent = `${elapsed}s`;
                document.getElementById('copy-btn').disabled = false;
                
                // Show validation
                if (result.validation_passed !== undefined) {
                    showValidation(result);
                }
                
            } catch (error) {
                alert('B≈ÇƒÖd: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üöÄ Generuj kod';
                progress.classList.add('d-none');
            }
        });
        
        // Copy button
        document.getElementById('copy-btn').addEventListener('click', () => {
            const code = document.getElementById('code-output').textContent;
            navigator.clipboard.writeText(code).then(() => {
                const btn = document.getElementById('copy-btn');
                btn.textContent = '‚úì Skopiowano!';
                setTimeout(() => btn.textContent = 'üìã Kopiuj', 2000);
            });
        });
        
        // Example cards
        document.querySelectorAll('.example-card').forEach(card => {
            card.addEventListener('click', () => {
                document.getElementById('intent-input').value = card.dataset.intent;
                if (card.dataset.type) {
                    document.getElementById('type-select').value = card.dataset.type;
                }
                if (card.dataset.platform) {
                    document.getElementById('platform-select').value = card.dataset.platform;
                }
            });
        });
        
        // Form backend generation
        document.getElementById('gen-form-backend').addEventListener('click', async () => {
            const form = document.getElementById('contact-form');
            const fields = Array.from(form.elements)
                .filter(el => el.name && el.type !== 'submit' && el.type !== 'button')
                .map(el => ({
                    name: el.name,
                    type: el.type === 'textarea' ? 'textarea' : el.type,
                    required: el.required
                }));
            
            const btn = document.getElementById('gen-form-backend');
            btn.disabled = true;
            btn.textContent = '‚è≥ Generowanie...';
            
            try {
                const result = await sendIntent(
                    `Create FastAPI endpoint to handle form submission with fields: ${fields.map(f => f.name).join(', ')}. Store data in PostgreSQL with proper validation.`,
                    {
                        intentType: 'api_endpoint',
                        targetPlatform: 'python_fastapi',
                        context: { fields, form_id: 'contact-form' }
                    }
                );
                
                const output = document.getElementById('form-backend-output');
                output.textContent = result.generated_code || '// No code generated';
                Prism.highlightElement(output);
                
            } catch (error) {
                alert('B≈ÇƒÖd: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generuj backend dla tego formularza';
            }
        });
        
        // Contact form submission
        document.getElementById('contact-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Send via MQTT
            const message = new Paho.MQTT.Message(JSON.stringify({
                action: 'create',
                data: data,
                request_id: crypto.randomUUID()
            }));
            message.destinationName = `${TOPIC_PREFIX}/forms/contact`;
            
            if (connected) {
                client.send(message);
                alert('Wiadomo≈õƒá wys≈Çana przez MQTT!');
                e.target.reset();
            } else {
                alert('Brak po≈ÇƒÖczenia z MQTT');
            }
        });
        
        function showValidation(result) {
            const container = document.getElementById('validation-results');
            const content = document.getElementById('validation-content');
            
            container.classList.remove('d-none');
            
            const status = result.validation_passed 
                ? '<span class="badge bg-success">‚úì Passed</span>'
                : '<span class="badge bg-danger">‚úó Failed</span>';
            
            const errors = result.validation_errors?.length 
                ? `<ul class="text-danger">${result.validation_errors.map(e => `<li>${e}</li>`).join('')}</ul>`
                : '';
            
            content.innerHTML = `
                <p>Status walidacji: ${status}</p>
                ${errors}
                <small class="text-muted">Czas przetwarzania: ${result.processing_time_ms?.toFixed(2) || '?'}ms</small>
            `;
        }
        
        // =================================================================
        // Initialize
        // =================================================================
        updateStatus('connecting');
        connectMQTT();
    </script>
</body>
</html>
